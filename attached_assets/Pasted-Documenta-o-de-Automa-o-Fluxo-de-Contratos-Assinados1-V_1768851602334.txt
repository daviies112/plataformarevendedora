Documentação de Automação: Fluxo de Contratos Assinados1. Visão GeralO sistema utiliza um Trigger (Gatilho) de banco de dados para eliminar processos manuais. No momento em que um contrato é marcado como "signed" (assinado) na tabela contracts, o sistema dispara automaticamente a criação de um cadastro de revendedor e a geração de uma ordem de envio.2. O Gatilho (Trigger)Tabela Origem: public.contractsEvento: AFTER INSERT OR UPDATE (Sempre que um contrato é criado ou editado).Condição de Execução: IF NEW.status = 'signed' (Apenas quando o status é exatamente 'signed').3. Fluxo de Dados (Mapeamento)Quando o gatilho é acionado, as seguintes ações ocorrem em paralelo:A. Criação de Revendedora (public.revendedoras)O sistema verifica se o cliente já existe como revendedor (via e-mail). Se não existir, ele cria o perfil:Coluna Origem (contracts)Coluna Destino (revendedoras)Observaçãoclient_namenomeNome completo do clienteclient_emailemailUsado como chave únicaclient_cpfcpfCPF formatadouser_idadmin_idVinculação com o admin (se disponível)Valor Fixosenha_hashGerado um hash padrão temporárioB. Geração de Ordem de Envio (public.envios)Uma nova linha é criada para que a expedição saiba para onde enviar o produto:Coluna Origem (contracts)Coluna Destino (envios)Finalidade Logísticaidcontract_idRastreabilidade do contratoclient_namedestinatario_nomeIdentificação no pacoteclient_emaildestinatario_emailNotificação de rastreioaddress_zipcodedestinatario_cepCálculo de rotaaddress_streetdestinatario_logradouroRua/Avenidaaddress_numberdestinatario_numeroNúmero da residênciaaddress_citydestinatario_cidadeCidade de destinoaddress_statedestinatario_ufEstado (UF)Valor FixostatusDefinido como 'pendente'4. Sistema de Auditoria (Logs)Para garantir que nenhuma informação se perca, criamos uma tabela de debug_logs.Se o envio falhar (ex: CPF inválido ou coluna faltando), o erro é registrado lá.Se o envio for bem-sucedido, uma mensagem de "Sucesso" é gravada com o ID do contrato.5. Observações Técnicas ImportantesSegurança: A função utiliza SECURITY DEFINER, o que permite que ela execute operações em tabelas restritas mesmo que o usuário final (cliente) não tenha permissão direta nelas.Tratamento de Conflitos: Na tabela de revendedoras, usamos ON CONFLICT (email) DO UPDATE. Isso significa que se um cliente assinar um segundo contrato, o cadastro dele será apenas atualizado, evitando erros de duplicidade.Dependência de ID: O campo admin_id depende do preenchimento do user_id na tabela de contratos. Caso esteja nulo, o sistema ainda processa o envio, mas sem vinculação a um administrador específico.Como testar a integração no Replit?Basta realizar um UPDATE via código ou painel:SQLUPDATE contracts SET status = 'signed' WHERE id = 'ID_DO_CONTRATO';
Após isso, verifique as tabelas revendedoras e envios para confirmar a entrada dos dados.