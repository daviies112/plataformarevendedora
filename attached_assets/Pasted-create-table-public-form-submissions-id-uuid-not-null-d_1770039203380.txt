create table public.form_submissions (
  id uuid not null default gen_random_uuid (),
  form_id uuid not null,
  answers jsonb not null,
  total_score integer not null,
  passed boolean not null,
  contact_name text null,
  contact_email text null,
  contact_phone text null,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  contact_cpf text null,
  tenant_id text null,
  instagram_handle text null,
  birth_date date null,
  address_cep text null,
  address_street text null,
  address_number text null,
  address_complement text null,
  address_neighborhood text null,
  address_city text null,
  address_state text null,
  processado_whatsapp boolean null default false,
  agendou_reuniao boolean null default false,
  data_agendamento timestamp with time zone null,
  follow_up_count integer null default 0,
  ultimo_follow_up timestamp with time zone null,
  follow_up_encerrado boolean null default false,
  participant_id text null,
  constraint form_submissions_pkey primary key (id),
  constraint form_submissions_participant_id_key unique (participant_id)
) TABLESPACE pg_default;

create index IF not exists idx_form_submissions_cpf on public.form_submissions using btree (contact_cpf) TABLESPACE pg_default;

create index IF not exists idx_form_submissions_tenant_id on public.form_submissions using btree (tenant_id) TABLESPACE pg_default;

create index IF not exists idx_form_submissions_participant_id on public.form_submissions using btree (participant_id) TABLESPACE pg_default
where
  (participant_id is not null);

create index IF not exists idx_form_submissions_address_city on public.form_submissions using btree (address_city) TABLESPACE pg_default;

create index IF not exists idx_form_submissions_address_state on public.form_submissions using btree (address_state) TABLESPACE pg_default;

create index IF not exists idx_form_submissions_processado_whatsapp on public.form_submissions using btree (processado_whatsapp) TABLESPACE pg_default
where
  (processado_whatsapp = false);

create index IF not exists idx_form_submissions_created_at on public.form_submissions using btree (created_at desc) TABLESPACE pg_default;

create index IF not exists idx_form_submissions_processado on public.form_submissions using btree (processado_whatsapp) TABLESPACE pg_default;

create index IF not exists idx_form_submissions_agendou on public.form_submissions using btree (agendou_reuniao) TABLESPACE pg_default;

create trigger on_new_submission_update_compliance
after INSERT on form_submissions for EACH row
execute FUNCTION marcar_compliance_como_respondido ();

create trigger update_form_submissions_updated_at BEFORE
update on form_submissions for EACH row
execute FUNCTION update_updated_at_column ();