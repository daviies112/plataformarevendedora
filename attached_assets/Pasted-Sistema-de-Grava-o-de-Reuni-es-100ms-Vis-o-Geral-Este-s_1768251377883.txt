Sistema de Grava√ß√£o de Reuni√µes 100ms
üìã Vis√£o Geral
Este sistema permite que administradores gravem reuni√µes manualmente atrav√©s de um bot√£o toggle. As grava√ß√µes s√£o processadas pelo servidor 100ms (SFU - Server-Side) e salvas automaticamente no banco de dados local e no Supabase.

üéØ Funcionalidades
Comportamento do Bot√£o de Grava√ß√£o
Estado	Visual	A√ß√£o ao Clicar
N√£o Gravando	Bot√£o cinza escuro üîò	Inicia grava√ß√£o
Gravando	Bot√£o vermelho pulsante üî¥	Para grava√ß√£o
Caracter√≠sticas
‚úÖ Manual: N√£o inicia automaticamente
‚úÖ Visual Feedback: Bot√£o muda de cor (cinza ‚Üí vermelho)
‚úÖ Indicador: Texto "GRAVANDO" no header com anima√ß√£o pulse
‚úÖ SFU Recording: Grava√ß√£o server-side (sem browser)
‚úÖ Sincroniza√ß√£o: Salva local (PostgreSQL) + Supabase
‚úÖ Toast Notifications: Feedback ao usu√°rio

üèóÔ∏è Arquitetura do Sistema
Fluxo Completo
Supabase
PostgreSQL
100ms API
/api/100ms/recording/*
Meeting100ms.tsx
Administrador
Supabase
PostgreSQL
100ms API
/api/100ms/recording/*
Meeting100ms.tsx
Administrador
Clica no bot√£o (üîò ‚Üí üî¥)
POST /100ms/recording/start
Busca reuni√£o por roomId
Busca credenciais 100ms do tenant
Inicia grava√ß√£o SFU
Retorna recording ID
Salva grava√ß√£o (status: 'recording')
Sincro niza grava√ß√£o (async)
Retorna success
Atualiza estado (isRecording = true)
Mostra "GRAVANDO" no header
Clica novamente (üî¥ ‚Üí üîò)
POST /100ms/recording/stop
Para grava√ß√£o
Processa e retorna asset
Atualiza grava√ß√£o (status: 'completed')
Sincroniza atualiza√ß√£o (async)
Retorna success
Atualiza estado (isRecording = false)
Mostra toast "Grava√ß√£o parada"
üíª C√≥digo Fonte
Frontend: 
Meeting100ms.tsx
Estados
const [isRecording, setIsRecording] = useState(false);
const [recordingId, setRecordingId] = useState<string | null>(null);
Fun√ß√£o de Toggle
const handleToggleRecording = async () => {
  try {
    const currentRoomId = roomId || window.location.pathname.split('/').pop();
    if (!isRecording) {
      // INICIAR GRAVA√á√ÉO
      setIsRecording(true); // Feedback visual imediato
      
      const response = await fetch('/api/100ms/recording/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ roomId: currentRoomId }),
      });
      if (!response.ok) {
        setIsRecording(false);
        throw new Error('Erro ao iniciar grava√ß√£o');
      }
      const data = await response.json();
      setRecordingId(data.recordingId);
      toast.success("‚úÖ Grava√ß√£o iniciada!");
      
    } else {
      // PARAR GRAVA√á√ÉO
      const response = await fetch('/api/100ms/recording/stop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ roomId: currentRoomId }),
      });
      if (!response.ok) throw new Error('Erro ao parar grava√ß√£o');
      setIsRecording(false);
      setRecordingId(null);
      toast.success("‚è∏Ô∏è Grava√ß√£o parada! O v√≠deo ser√° processado em breve.");
    }
  } catch (err: any) {
    toast.error("‚ùå " + err.message);
  }
};
Bot√£o de Grava√ß√£o
<Button
  onClick={handleToggleRecording}
  variant={isRecording ? "destructive" : "ghost"}
  size="icon"
  className={cn(
    "h-12 w-12 rounded-2xl transition-all duration-300",
    isRecording 
      ? "bg-red-500 text-white shadow-lg shadow-red-500/20" 
      : "bg-zinc-800/50 text-white hover:bg-zinc-700"
  )}
  title={isRecording ? "Parar grava√ß√£o" : "Iniciar grava√ß√£o"}
>
  <Circle className={cn(
    "h-5 w-5", 
    isRecording && "fill-white animate-pulse"
  )} />
</Button>
Indicador no Header
{isRecordingOn && (
  <div className="flex items-center gap-1 mt-0.5 animate-pulse">
    <Circle className="h-1.5 w-1.5 fill-red-500 text-red-500" />
    <span className="text-[9px] text-red-500 font-bold uppercase tracking-wider">
      Gravando
    </span>
  </div>
)}
Backend: 
server/routes/meetings.ts
Endpoint: Iniciar Grava√ß√£o
// POST /api/100ms/recording/start
publicRoomDesignRouter.post('/100ms/recording/start', async (req, res) => {
  try {
    const { roomId } = req.body;
    if (!roomId) {
      return res.status(400).json({ error: 'roomId √© obrigat√≥rio' });
    }
    console.log(`[Recording] Iniciando grava√ß√£o para roomId: ${roomId}`);
    // 1. Buscar reuni√£o
    const [meeting] = await db.select().from(reunioes)
      .where(eq(reunioes.roomId100ms, roomId))
      .limit(1);
    if (!meeting) {
      return res.status(404).json({ error: 'Reuni√£o n√£o encontrada' });
    }
    // 2. Buscar credenciais 100ms do tenant
    const credentials = await get100msCredentialsForTenant(meeting.tenantId);
    if (!credentials) {
      return res.status(400).json({ 
        error: 'Credenciais do 100ms n√£o configuradas' 
      });
    }
    // 3. Iniciar grava√ß√£o SFU (Server-Side) via 100ms API
    const result = await iniciarGravacao(
      roomId,
      credentials.appAccessKey,
      credentials.appSecret
    );
    console.log(`[Recording] Grava√ß√£o iniciada:`, result);
    // 4. Salvar no banco local
    const [gravacao] = await db.insert(gravacoes).values({
      reuniaoId: meeting.id,
      tenantId: meeting.tenantId,
      roomId100ms: roomId,
      sessionId100ms: result.session_id,
      recordingId100ms: result.id,
      status: 'recording',
      startedAt: new Date(),
    }).returning();
    // 5. Sincronizar com Supabase (async, n√£o bloqueia resposta)
    syncRecordingToSupabase(meeting.tenantId, gravacao).catch(console.error);
    // 6. Retornar sucesso
    res.json({ 
      success: true, 
      recording: gravacao, 
      recordingId: result.id,
      hmsResult: result 
    });
    
  } catch (error: any) {
    console.error('[Recording] Erro:', error);
    res.status(500).json({ 
      error: 'Erro ao iniciar grava√ß√£o', 
      message: error.message 
    });
  }
});
Endpoint: Parar Grava√ß√£o
// POST /api/100ms/recording/stop
publicRoomDesignRouter.post('/100ms/recording/stop', async (req, res) => {
  try {
    const { roomId } = req.body;
    if (!roomId) {
      return res.status(400).json({ error: 'roomId √© obrigat√≥rio' });
    }
    // 1. Buscar reuni√£o
    const [meeting] = await db.select().from(reunioes)
      .where(eq(reunioes.roomId100ms, roomId))
      .limit(1);
    if (!meeting) {
      return res.status(404).json({ error: 'Reuni√£o n√£o encontrada' });
    }
    // 2. Buscar credenciais
    const credentials = await get100msCredentialsForTenant(meeting.tenantId);
    
    // 3. Parar grava√ß√£o via 100ms API
    const result = await pararGravacao(
      roomId,
      credentials.appAccessKey,
      credentials.appSecret
    );
    console.log(`[Recording] Grava√ß√£o parada:`, result);
    // 4. Tentar obter asset imediatamente
    let finalStatus = 'processing';
    let fileUrl = null;
    let duration = null;
    let fileSize = null;
    if (result.asset?.id) {
      try {
        const presigned = await obterUrlPresignadaAsset(
          result.asset.id,
          credentials.appAccessKey,
          credentials.appSecret
        );
        fileUrl = presigned.url;
        finalStatus = 'completed';
        duration = result.asset.duration || null;
        fileSize = result.asset.size || null;
      } catch (assetError) {
        console.log(`[Recording] Asset ainda n√£o pronto, status: processing`);
      }
    }
    // 5. Atualizar grava√ß√£o no banco local
    const [updatedRecording] = await db.update(gravacoes)
      .set({
        status: finalStatus,
        stoppedAt: new Date(),
        updatedAt: new Date(),
        fileUrl: fileUrl,
        duration: duration,
        fileSize: fileSize,
        assetId: result.asset?.id || null,
      })
      .where(and(
        eq(gravacoes.roomId100ms, roomId),
        eq(gravacoes.status, 'recording')
      ))
      .returning();
    // 6. Sincronizar atualiza√ß√£o no Supabase (async)
    if (updatedRecording) {
      syncRecordingToSupabase(meeting.tenantId, updatedRecording)
        .catch(console.error);
    }
    res.json({ success: true, status: finalStatus, hmsResult: result });
    
  } catch (error: any) {
    console.error('[Recording] Erro ao parar:', error);
    res.status(500).json({ 
      error: 'Erro ao parar grava√ß√£o', 
      message: error.message 
    });
  }
});
Fun√ß√£o de Sincroniza√ß√£o com Supabase
async function syncRecordingToSupabase(tenantId: string, recording: any) {
  try {
    const supabase = await getClientSupabaseClient(tenantId);
    if (!supabase) {
      console.log(`[Recording Sync] Supabase n√£o configurado para tenant ${tenantId}`);
      return;
    }
    // Serializar datas para ISO strings
    const toISOString = (date: Date | string | null | undefined): string | null => {
      if (!date) return null;
      if (date instanceof Date) return date.toISOString();
      if (typeof date === 'string') return date;
      return null;
    };
    const { error } = await supabase
      .from('gravacoes')
      .upsert({
        id: recording.id,
        reuniao_id: recording.reuniaoId,
        tenant_id: recording.tenantId,
        room_id_100ms: recording.roomId100ms || null,
        session_id_100ms: recording.sessionId100ms || null,
        recording_id_100ms: recording.recordingId100ms || null,
        asset_id: recording.assetId || null,
        status: recording.status || 'recording',
        started_at: toISOString(recording.startedAt),
        stopped_at: toISOString(recording.stoppedAt),
        duration: recording.duration || null,
        file_url: recording.fileUrl || null,
        file_size: recording.fileSize || null,
        thumbnail_url: recording.thumbnailUrl || null,
        metadata: recording.metadata || {},
        created_at: toISOString(recording.createdAt),
        updated_at: toISOString(recording.updatedAt),
      }, { onConflict: 'id' });
    if (error) {
      console.error(`[Recording Sync] Erro:`, error);
    } else {
      console.log(`[Recording Sync] Sucesso para grava√ß√£o ${recording.id}`);
    }
  } catch (err) {
    console.error(`[Recording Sync] Erro inesperado:`, err);
  }
}
üóÑÔ∏è Estrutura do Banco de Dados
Tabela: gravacoes
Campo	Tipo	Descri√ß√£o
id
UUID	ID √∫nico da grava√ß√£o
reuniao_id	UUID	ID da reuni√£o
tenant_id	TEXT	ID do tenant (multi-tenant)
room_id_100ms	TEXT	Room ID do 100ms
session_id_100ms	TEXT	Session ID retornado pela API
recording_id_100ms	TEXT	Recording ID retornado pela API
asset_id	TEXT	Asset ID do v√≠deo processado
status	TEXT	recording / processing / completed / failed
started_at	TIMESTAMP	Data/hora de in√≠cio
stopped_at	TIMESTAMP	Data/hora de parada
duration	INTEGER	Dura√ß√£o em segundos
file_url	TEXT	URL presignada do v√≠deo
file_size	BIGINT	Tamanho do arquivo em bytes
thumbnail_url	TEXT	URL da thumbnail
metadata	JSONB	Metadados adicionais
created_at	TIMESTAMP	Data de cria√ß√£o
updated_at	TIMESTAMP	Data de atualiza√ß√£o
Ciclo de Vida de uma Grava√ß√£o
1. [Iniciar] ‚Üí Status: 'recording'
   - started_at: NOW()
   - recording_id_100ms: [ID da API]
2. [Parar] ‚Üí Status: 'processing' ou 'completed'
   - stopped_at: NOW()
   - Tenta obter asset imediatamente
   - Se asset dispon√≠vel: status = 'completed'
   - Se n√£o: status = 'processing'
3. [Processamento conclu√≠do] ‚Üí Status: 'completed'
   - file_url: [URL presignada]
   - duration: [segundos]
   - file_size: [bytes]
‚úÖ Checklist de Verifica√ß√£o
Antes de Gravar
 Administrador est√° logado
 Reuni√£o est√° ativa (ao menos 1 participante)
 Credenciais 100ms configuradas para o tenant
 Template 100ms tem role "recorder" configurada
Durante a Grava√ß√£o
 Bot√£o est√° vermelho üî¥
 Indicador "GRAVANDO" vis√≠vel no header
 Console mostra logs [Recording] Iniciando grava√ß√£o...
Ap√≥s Parar
 Bot√£o volta para cinza üîò
 Toast "Grava√ß√£o parada" aparece
 Registro aparece na tabela gravacoes (local)
 Registro sincronizado no Supabase
üêõ Troubleshooting
Problema: Bot√£o n√£o muda de cor
Sintomas:

Clica no bot√£o mas continua cinza
Sem toast de confirma√ß√£o
Diagn√≥stico:

# No console do navegador:
1. Abra F12 > Console
2. Procure por erros tipo "404" ou "500"
3. Verifique se `roomId` est√° sendo enviado
Solu√ß√µes:

Verifique se roomId est√° definido:
console.log("RoomId:", roomId || window.location.pathname.split('/').pop());
Verifique se a reuni√£o existe no banco:
SELECT * FROM reunioes WHERE room_id_100ms = 'SEU_ROOM_ID';
Problema: Erro "Credenciais n√£o configuradas"
Sintomas:

Toast vermelho: "Erro ao iniciar grava√ß√£o"
Console backend: Credenciais do 100ms n√£o configuradas
Solu√ß√£o:

Acesse Configura√ß√µes > Integra√ß√µes > 100ms
Preencha:
App Access Key
App Secret
Template ID
Clique em "Testar Conex√£o 100ms"
Salve
Problema: Grava√ß√£o n√£o aparece no Supabase
Sintomas:

Grava√ß√£o salva localmente
N√£o aparece no Supabase
Diagn√≥stico:

// Backend logs:
[Recording Sync] Supabase n√£o configurado para tenant X
Solu√ß√£o:

Verifique se o Supabase est√° configurado para o tenant:
SELECT * FROM supabase_config WHERE tenant_id = 'SEU_TENANT_ID';
Configure as credenciais do Supabase em Configura√ß√µes
Problema: V√≠deo em "processing" por muito tempo
Sintomas:

Status fica "processing" por mais de 10 minutos
Solu√ß√£o:

Use o endpoint de refresh:
POST /api/gravacoes/:id/refresh
Ou verifique no dashboard do 100ms:
Acesse dashboard.100ms.live
V√° em Sessions
Procure a sess√£o da reuni√£o
Verifique se a grava√ß√£o terminou
üß™ Como Testar
Teste Manual Completo
Iniciar Reuni√£o

1. Fa√ßa login como administrador
2. Crie uma reuni√£o instant√¢nea
3. Entre na reuni√£o
Iniciar Grava√ß√£o

1. Clique no bot√£o de grava√ß√£o (c√≠rculo cinza)
2. Verifique se fica vermelho
3. Verifique se aparece "GRAVANDO" no header
4. Fale algo ou mova a c√¢mera
Parar Grava√ß√£o

1. Clique novamente no bot√£o (agora vermelho)
2. Verifique se volta para cinza
3. Aguarde o toast "Grava√ß√£o parada"
Verificar Grava√ß√£o

-- No banco de dados
SELECT * FROM gravacoes 
WHERE status IN ('recording', 'processing', 'completed')
ORDER BY created_at DESC 
LIMIT 1;
Aguardar Processamento

Aguarde 2-5 minutos
A grava√ß√£o ser√° processada pelo 100ms
Status mudar√° de 'processing' para 'completed'
Acessar V√≠deo

1. V√° para /gravacoes
2. Encontre a grava√ß√£o
3. Clique para assistir
üìä Logs Importantes
Backend (Console do Servidor)
[Recording] Iniciando grava√ß√£o para roomId: room_abc123
[Recording] Reuni√£o encontrada: uuid-reuniao, tenant: tenant_xyz
[Recording] Iniciando grava√ß√£o SFU (Server-Side) para roomId: room_abc123
[Recording] Grava√ß√£o iniciada com sucesso: { id: 'rec_xyz', session_id: 'sess_abc' }
[Recording Sync] Grava√ß√£o rec_xyz sincronizada com Supabase para tenant tenant_xyz
Frontend (Console do Navegador)
[Meeting100ms] Click no bot√£o de grava√ß√£o
Toast: ‚úÖ Grava√ß√£o iniciada!
Toast: ‚è∏Ô∏è Grava√ß√£o parada! O v√≠deo ser√° processado em breve.
üé¨ Diferen√ßa: SFU vs Browser Recording
SFU (Server-Side) - USADO ATUALMENTE ‚úÖ
Aspecto	Detalhes
Onde grava	Servidor 100ms
Requisitos	Nenhum (sem bot de grava√ß√£o)
Qualidade	Alta (composi√ß√£o server-side)
Confiabilidade	Alta (n√£o depende do browser)
Browser Recording - N√ÉO USADO ‚ùå
Aspecto	Detalhes
Onde grava	Browser do bot
Requisitos	Bot precisa entrar na reuni√£o
Qualidade	Depende do bot
Confiabilidade	Menor (depende de internet do bot)
üîë Permiss√µes Necess√°rias
No Template 100ms
A role recorder deve existir com:

‚úÖ Can publish audio
‚úÖ Can publish video
‚úÖ Can subscribe to all roles
‚úÖ Can join room
‚ö†Ô∏è Nota: Para SFU recording, a role recorder n√£o √© usada diretamente (o servidor grava sem entrar como peer), mas √© boa pr√°tica t√™-la configurada.

üìö Refer√™ncias
100ms Recording Documentation
SFU Recording Guide
Arquivo: server/services/meetings/hms100ms.ts (fun√ß√µes 
iniciarGravacao
 e 
pararGravacao
)
Arquivo: 
src/components/Meeting100ms.tsx
 (bot√£o e estado)
Documenta√ß√£o criada em: 12 de Janeiro de 2026
Vers√£o: 1.0
Status do Sistema: ‚úÖ Funcionando (conforme c√≥digo auditado)