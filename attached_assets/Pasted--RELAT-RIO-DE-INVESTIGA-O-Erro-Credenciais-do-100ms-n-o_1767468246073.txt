üîç RELAT√ìRIO DE INVESTIGA√á√ÉO: Erro "Credenciais do 100ms n√£o configuradas"
Data: 03 de Janeiro de 2026
Erro: 400: {"success":false,"message":"Credenciais do 100ms n√£o configuradas"}
Status: ‚úÖ Problemas Identificados

üìä RESUMO EXECUTIVO
Ap√≥s an√°lise exaustiva do c√≥digo, identifiquei 4 problemas principais que causam o erro de credenciais n√£o configuradas, mesmo ap√≥s voc√™ ter salvo as configura√ß√µes.

üî¥ PROBLEMA #1: DIVERG√äNCIA DE TENANT IDs
Descri√ß√£o
O sistema est√° usando IDs diferentes para salvar e buscar as credenciais.

Evid√™ncias no C√≥digo
Quando voc√™ SALVA (via /configuracoes):

// Arquivo: server/routes/config.ts (linha 21)
import { hms100msConfig } from "../../shared/db-schema";
// O endpoint de salvamento usa o tenantId da sess√£o atual
const tenantId = req.user!.tenantId; // Ex: "dev-daviemericko_gmail_com"
Quando o sistema BUSCA (ao criar reuni√£o):

// Arquivo: server/routes/meetings.ts (linhas 33-42)
async function getHMS100msCredentials(tenantId: string) {
  console.log(`[MEETINGS] Buscando credenciais para tenantId: "${tenantId}"`);
  
  // Normaliza para UUID fixo em desenvolvimento
  const syncedTenantId = (tenantId === 'dev-daviemericko_gmail_com' || tenantId === 'system')
    ? 'f5d8c8d9-7c9e-4b8a-9c7d-4e3b8a9c7d4e'  // ‚Üê UUID fixo
    : tenantId;
  console.log(`[MEETINGS] TenantId sincronizado: "${syncedTenantId}"`);
  
  // Busca na tabela hms_100ms_config
  const [config] = await db
    .select()
    .from(hms100msConfig)
    .where(eq(hms100msConfig.tenantId, syncedTenantId)); // ‚Üê Busca com UUID
Problema
Voc√™ salva com tenantId = "dev-daviemericko_gmail_com"
Sistema busca com tenantId = "f5d8c8d9-7c9e-4b8a-9c7d-4e3b8a9c7d4e"
Resultado: Credenciais n√£o encontradas! ‚ùå
üî¥ PROBLEMA #2: ENDPOINT DE CONFIGURA√á√ÉO 100MS N√ÉO EXISTE
Descri√ß√£o
A tabela hms_100ms_config existe no schema, mas N√ÉO H√Å ENDPOINT para salvar credenciais nela!

Evid√™ncias
Tabela existe:

// Arquivo: shared/db-schema.ts (linha 217)
export const hms100msConfig = pgTable('hms_100ms_config', {
  id: serial('id').primaryKey(),
  tenantId: text('tenant_id').notNull(),
  appAccessKey: text('app_access_key').notNull(),
  appSecret: text('app_secret').notNull(),
  managementToken: text('management_token'),
  templateId: text('template_id'),
  // ...
});
Mas o endpoint N√ÉO existe:

// Arquivo: server/routes/config.ts
// ‚ùå N√ÉO H√Å:
// app.post("/api/config/hms-100ms", ...)
// app.get("/api/config/hms-100ms", ...)
// ‚úÖ Existem para outras integra√ß√µes:
app.post("/api/config/redis", ...)
app.post("/api/config/sentry", ...)
app.post("/api/config/resend", ...)
// ... mas 100ms est√° FALTANDO!
Consequ√™ncia
Voc√™ est√° salvando as credenciais em outro lugar (provavelmente via frontend direto), mas o backend de reuni√µes busca na tabela hms_100ms_config que est√° vazia.

üî¥ PROBLEMA #3: NORMALIZA√á√ÉO INCONSISTENTE
Descri√ß√£o
A normaliza√ß√£o de tenant ID acontece em momentos diferentes e de formas diferentes.

Evid√™ncias
No middleware de autentica√ß√£o:

// Arquivo: server/routes/meetings.ts (linhas 89-121)
router.use((req: Request, res: Response, next) =\u003e {
  if (!req.session?.userId) {
    if (process.env.NODE_ENV === 'development') {
      // Usa UUID fixo para desenvolvimento
      const DEV_TENANT_ID = 'f5d8c8d9-7c9e-4b8a-9c7d-4e3b8a9c7d4e';
      (req as any).user = { 
        id: DEV_TENANT_ID, 
        tenantId: DEV_TENANT_ID,  // ‚Üê J√° normalizado aqui
        // ...
      };
      return next();
    }
    return res.status(401).json({ success: false, message: 'N√£o autenticado' });
  }
  
  const tenantIdFromSession = req.session.tenantId || 'f5d8c8d9-7c9e-4b8a-9c7d-4e3b8a9c7d4e';
  
  // Normaliza NOVAMENTE
  const syncedTenantId = tenantIdFromSession === 'dev-daviemericko_gmail_com'
    ? 'f5d8c8d9-7c9e-4b8a-9c7d-4e3b8a9c7d4e'
    : tenantIdFromSession;
  
  // ...
});
Na fun√ß√£o de busca de credenciais:

// Arquivo: server/routes/meetings.ts (linhas 37-39)
// Normaliza PELA TERCEIRA VEZ!
const syncedTenantId = (tenantId === 'dev-daviemericko_gmail_com' || tenantId === 'system')
  ? 'f5d8c8d9-7c9e-4b8a-9c7d-4e3b8a9c7d4e'
  : tenantId;
Problema
Normaliza√ß√£o acontece em 3 lugares diferentes
Se a sess√£o vier com dev-daviemericko_gmail_com, mas a fun√ß√£o espera system, a normaliza√ß√£o falha
Inconsist√™ncia entre salvamento e busca
üî¥ PROBLEMA #4: VALIDA√á√ÉO UUID PREMATURA
Descri√ß√£o
O c√≥digo aborta a busca se o tenant ID n√£o for um UUID v√°lido, mesmo antes de tentar normalizar.

Evid√™ncias
// Arquivo: server/routes/meetings.ts (linhas 58-64)
// Verifica se √© UUID ANTES de tentar buscar
const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(tenantId);
if (!isUuid) {
  console.warn(`[MEETINGS] tenantId "${tenantId}" is not a valid UUID, skipping meeting_tenants lookup`);
  return null;  // ‚Üê RETORNA NULL PREMATURAMENTE!
}
Problema
Se tenantId = "dev-daviemericko_gmail_com" (n√£o √© UUID)
C√≥digo normaliza para UUID: f5d8c8d9-...
MAS depois valida o UUID do tenantId ORIGINAL (n√£o normalizado)
Falha na valida√ß√£o e retorna null
Sistema diz "credenciais n√£o configuradas"
üîç FLUXO COMPLETO DO ERRO
1. Usu√°rio salva credenciais 100ms via /configuracoes
   ‚Üì
   tenantId da sess√£o: "dev-daviemericko_gmail_com"
   ‚Üì
   ‚ùå PROBLEMA: N√£o h√° endpoint /api/config/hms-100ms
   ‚Üì
   Credenciais salvam em lugar ERRADO ou N√ÉO salvam
2. Usu√°rio tenta criar reuni√£o instant√¢nea
   ‚Üì
   POST /api/reunioes/instantanea
   ‚Üì
   Middleware normaliza: "dev-daviemericko_gmail_com" ‚Üí "f5d8c8d9-..."
   ‚Üì
   Chama getHMS100msCredentials("f5d8c8d9-...")
   ‚Üì
   Normaliza NOVAMENTE (redundante)
   ‚Üì
   Busca na tabela hms_100ms_config com UUID
   ‚Üì
   ‚ùå N√ÉO ENCONTRA (porque salvou com outro ID ou n√£o salvou)
   ‚Üì
   Tenta fallback em meeting_tenants
   ‚Üì
   Valida se tenantId √© UUID
   ‚Üì
   ‚ùå FALHA (porque validou o ID original, n√£o o normalizado)
   ‚Üì
   return null;
   ‚Üì
   Sistema retorna: "Credenciais do 100ms n√£o configuradas"
üìã LOGS ESPERADOS
Com base no c√≥digo, os logs devem mostrar:

[MEETINGS] Buscando credenciais para tenantId: "f5d8c8d9-7c9e-4b8a-9c7d-4e3b8a9c7d4e"
[MEETINGS] TenantId sincronizado: "f5d8c8d9-7c9e-4b8a-9c7d-4e3b8a9c7d4e"
[MEETINGS] tenantId "dev-daviemericko_gmail_com" is not a valid UUID, skipping meeting_tenants lookup
POST /api/reunioes/instantanea 400 ... {"success":false,"message":"Credenciais do 100ms n√£o configuradas"}
‚úÖ SOLU√á√ïES RECOMENDADAS
Solu√ß√£o 1: Criar Endpoint de Configura√ß√£o 100ms
// Adicionar em server/routes/config.ts
app.post("/api/config/hms-100ms", authenticateConfig, async (req: AuthRequest, res) =\u003e {
  try {
    const { appAccessKey, appSecret, templateId } = req.body;
    const tenantId = req.user!.tenantId;
    
    // Normalizar tenant ID AQUI (mesma l√≥gica de meetings.ts)
    const syncedTenantId = (tenantId === 'dev-daviemericko_gmail_com' || tenantId === 'system')
      ? 'f5d8c8d9-7c9e-4b8a-9c7d-4e3b8a9c7d4e'
      : tenantId;
    
    if (!appAccessKey || !appSecret) {
      return res.status(400).json({
        error: "appAccessKey e appSecret s√£o obrigat√≥rios",
      });
    }
    
    const encryptedKey = encrypt(appAccessKey);
    const encryptedSecret = encrypt(appSecret);
    
    const existingConfig = await db.select().from(hms100msConfig)
      .where(eq(hms100msConfig.tenantId, syncedTenantId))
      .limit(1);
    
    if (existingConfig[0]) {
      await db.update(hms100msConfig)
        .set({
          appAccessKey: encryptedKey,
          appSecret: encryptedSecret,
          templateId: templateId || null,
          updatedAt: new Date(),
        })
        .where(eq(hms100msConfig.id, existingConfig[0].id));
      
      console.log(`‚úÖ Configura√ß√£o 100ms atualizada para tenant ${syncedTenantId}`);
      return res.json({
        success: true,
        message: "Credenciais atualizadas com sucesso",
      });
    } else {
      await db.insert(hms100msConfig).values({
        tenantId: syncedTenantId,
        appAccessKey: encryptedKey,
        appSecret: encryptedSecret,
        templateId: templateId || null,
      });
      
      console.log(`‚úÖ Configura√ß√£o 100ms salva para tenant ${syncedTenantId}`);
      return res.json({
        success: true,
        message: "Credenciais salvas com sucesso",
      });
    }
  } catch (error) {
    console.error("Erro ao salvar configura√ß√£o 100ms:", error);
    return res.status(500).json({
      error: "Erro ao salvar configura√ß√£o",
      message: error instanceof Error ? error.message : "Erro desconhecido",
    });
  }
});
Solu√ß√£o 2: Centralizar Normaliza√ß√£o de Tenant ID
// Criar fun√ß√£o helper em server/lib/tenantUtils.ts
export function normalizeTenantId(tenantId: string): string {
  // Lista de IDs de desenvolvimento que devem ser normalizados
  const DEV_TENANT_IDS = [
    'dev-daviemericko_gmail_com',
    'system',
    'development'
  ];
  
  const DEV_UUID = 'f5d8c8d9-7c9e-4b8a-9c7d-4e3b8a9c7d4e';
  
  // Se for ID de dev, retorna UUID fixo
  if (DEV_TENANT_IDS.includes(tenantId)) {
    return DEV_UUID;
  }
  
  // Caso contr√°rio, retorna o pr√≥prio ID
  return tenantId;
}
// Usar em TODOS os lugares:
// - server/routes/meetings.ts
// - server/routes/config.ts
// - server/middleware/auth.ts
Solu√ß√£o 3: Remover Valida√ß√£o UUID Prematura
// Em server/routes/meetings.ts (linha 58-64)
// REMOVER ou mover DEPOIS da normaliza√ß√£o:
async function getHMS100msCredentials(tenantId: string) {
  console.log(`[MEETINGS] Buscando credenciais para tenantId: "${tenantId}"`);
  
  // Normalizar PRIMEIRO
  const syncedTenantId = normalizeTenantId(tenantId);
  console.log(`[MEETINGS] TenantId sincronizado: "${syncedTenantId}"`);
  
  // Buscar na tabela hms_100ms_config
  const [config] = await db
    .select()
    .from(hms100msConfig)
    .where(eq(hms100msConfig.tenantId, syncedTenantId));
  if (config) {
    return {
      appAccessKey: decrypt(config.appAccessKey),
      appSecret: decrypt(config.appSecret),
      templateId: config.templateId,
    };
  }
  // Validar UUID SOMENTE para fallback
  const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(syncedTenantId);
  
  if (!isUuid) {
    console.warn(`[MEETINGS] Tenant ID normalizado "${syncedTenantId}" n√£o √© UUID v√°lido`);
    return null;
  }
  // Fallback para meeting_tenants
  const [tenant] = await db
    .select()
    .from(meetingTenants)
    .where(eq(meetingTenants.id, syncedTenantId));
  // ... resto do c√≥digo
}
Solu√ß√£o 4: Adicionar Logs Detalhados
// Adicionar em getHMS100msCredentials:
console.log(`[MEETINGS] üîç Debug de credenciais:`);
console.log(`[MEETINGS]    - Tenant ID original: "${tenantId}"`);
console.log(`[MEETINGS]    - Tenant ID normalizado: "${syncedTenantId}"`);
console.log(`[MEETINGS]    - √â UUID v√°lido: ${isUuid}`);
console.log(`[MEETINGS]    - Buscando em hms_100ms_config...`);
const [config] = await db.select().from(hms100msConfig)
  .where(eq(hms100msConfig.tenantId, syncedTenantId));
console.log(`[MEETINGS]    - Resultado hms_100ms_config: ${config ? '‚úÖ ENCONTRADO' : '‚ùå N√ÉO ENCONTRADO'}`);
if (!config) {
  console.log(`[MEETINGS]    - Tentando fallback em meeting_tenants...`);
  // ... resto do c√≥digo
}
üéØ A√á√ÉO IMEDIATA RECOMENDADA
Verificar onde as credenciais foram salvas:

-- No banco de dados PostgreSQL
SELECT * FROM hms_100ms_config;
SELECT * FROM meeting_tenants WHERE id = 'f5d8c8d9-7c9e-4b8a-9c7d-4e3b8a9c7d4e';
SELECT * FROM meeting_tenants WHERE id = 'dev-daviemericko_gmail_com';
Criar endpoint /api/config/hms-100ms (Solu√ß√£o 1)

Salvar credenciais novamente usando o endpoint correto

Testar cria√ß√£o de reuni√£o e verificar logs

üìä CONCLUS√ÉO
O erro ocorre devido a uma combina√ß√£o de 4 problemas:

‚ùå Diverg√™ncia de IDs - Salva com um ID, busca com outro
‚ùå Endpoint faltando - N√£o h√° rota para salvar credenciais 100ms
‚ùå Normaliza√ß√£o inconsistente - Acontece em m√∫ltiplos lugares
‚ùå Valida√ß√£o prematura - Aborta antes de normalizar
Causa raiz: O sistema foi projetado para multi-tenant com UUIDs, mas o desenvolvimento usa IDs de texto (dev-daviemericko_gmail_com). A normaliza√ß√£o existe, mas est√° mal implementada e inconsistente.

Solu√ß√£o: Implementar as 4 solu√ß√µes acima para garantir que:

Credenciais sejam salvas no lugar certo
Normaliza√ß√£o aconte√ßa de forma consistente
Valida√ß√µes n√£o bloqueiem prematuramente