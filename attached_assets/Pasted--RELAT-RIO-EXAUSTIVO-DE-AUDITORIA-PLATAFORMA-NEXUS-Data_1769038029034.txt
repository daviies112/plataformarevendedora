üìã RELAT√ìRIO EXAUSTIVO DE AUDITORIA - PLATAFORMA NEXUS
Data da Auditoria: 2026-01-21 Realizado por: Gemini 3 Pro (Fase 1: Descoberta) Objetivo: Catalogar TODOS os erros, vulnerabilidades e d√©bitos t√©cnicos para corre√ß√£o pelo Claude Opus 4.5

üìä RESUMO EXECUTIVO
Categoria	Itens Encontrados	Severidade
üî¥ C√≥digo Legado Stripe	68+ refer√™ncias	CR√çTICA
üî¥ Depend√™ncias Stripe	3 pacotes	CR√çTICA
üü† Console.log em Produ√ß√£o	2000+ linhas	ALTA
üü† Uso de 
any
 Type	700+ inst√¢ncias	ALTA
üü¢ Chaves Hardcoded	0 encontradas	OK
üü¢ Prote√ß√£o de Rotas	Implementada	OK
üî¥ SE√á√ÉO 1: REMO√á√ÉO COMPLETA DO STRIPE (CR√çTICA)
1.1 Arquivos Frontend para DELETAR
Os seguintes arquivos devem ser completamente removidos pois implementam l√≥gica do Stripe:

src/features/revendedora/services/StripeService.ts      [DELETE]
src/features/revendedora/pages/reseller/PaymentCard.tsx [REFACTOR ‚Üí Pagar.me]
1.2 Arquivo de Index para Atualizar
Arquivo: src/features/revendedora/index.ts Linha 86:

// REMOVER ESTA LINHA:
export * from './services/StripeService';
1.3 Arquivo PaymentService.ts - Migrar para Pagar.me
Arquivo: 
src/features/revendedora/services/PaymentService.ts

Problema: O arquivo ainda usa rotas /api/payments/create-intent que eram do Stripe.

Linhas a Corrigir:

// LINHA 117 - Coment√°rio ERRADO:
// 4. Para PIX ou CART√ÉO, usar API local para Stripe
// CORRIGIR PARA:
// 4. Para PIX ou CART√ÉO, usar API local para Pagar.me
// LINHA 118 - Rota ERRADA:
const response = await fetch('/api/payments/create-intent', {
// CORRIGIR PARA (dependendo da implementa√ß√£o):
const response = await fetch('/api/public/checkout/pix', { // ou /card
1.4 Depend√™ncias package.json para REMOVER
Arquivo: 
package.json

// LINHAS 54-55 e 68 - REMOVER:
"@stripe/react-stripe-js": "^5.4.1",
"@stripe/stripe-js": "^8.5.3",
"@types/stripe": "^8.0.416",
Comando para remo√ß√£o:

npm uninstall @stripe/react-stripe-js @stripe/stripe-js @types/stripe
1.5 Refer√™ncias Stripe no Frontend - Arquivos para Auditar
Arquivo	Linha	Problema
src/features/revendedora/types/database.ts	102	stripe_account_id?: string;
src/features/revendedora/pages/admin/CommissionConfiguration.tsx	421	Menciona "split de pagamento via Stripe"
src/features/revendedora/pages/reseller/PaymentCard.tsx
3-12	Imports do Stripe
üü† SE√á√ÉO 2: CONSOLE.LOG EM PRODU√á√ÉO (ALTA)
2.1 Arquivos do Servidor com console.log excessivo
Os seguintes arquivos t√™m console.log que devem ser removidos ou substitu√≠dos por logger estruturado:

Arquivo	Quantidade Aprox.
server/services/pagarme.ts
20+ logs
server/services/n8n.ts	10+ logs
server/services/envioService.ts	15+ logs
server/services/init.ts	15+ logs
server/routes/*.ts	50+ logs cada
TOTAL ESTIMADO	2000+
2.2 Solu√ß√£o Recomendada
Substituir todos os console.log por um logger estruturado como Pino (j√° instalado):

// ANTES (ERRADO):
console.log('[Pagar.me] Creating PIX order');
// DEPOIS (CORRETO):
import { logger } from '../lib/logger';
logger.info({ context: 'Pagar.me' }, 'Creating PIX order');
A√ß√£o: Criar arquivo server/lib/logger.ts se n√£o existir:

import pino from 'pino';
export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport: process.env.NODE_ENV === 'development' 
    ? { target: 'pino-pretty' } 
    : undefined
});
üü† SE√á√ÉO 3: USO EXCESSIVO DE 
any
 (ALTA)
3.1 Arquivos com Maior Incid√™ncia
Arquivo	Inst√¢ncias
server/routes/workspace.ts
35+
server/routes/whatsapp-complete.ts
15+
server/routes/dashboard.ts
20+
server/routes/leadsPipelineRoutes.ts
25+
server/routes/meetings.ts
15+
TOTAL	700+
3.2 Padr√µes Comuns a Corrigir
Padr√£o 1: Erro gen√©rico

// ERRADO:
} catch (error: any) {
  console.error(error.message);
}
// CORRETO:
} catch (error) {
  if (error instanceof Error) {
    console.error(error.message);
  }
}
Padr√£o 2: Retorno de fun√ß√£o

// ERRADO:
function getClientCredentials(clientId: string, integrationType: string): any | null {
// CORRETO:
interface ClientCredentials {
  url?: string;
  anonKey?: string;
  // ... outras propriedades
}
function getClientCredentials(clientId: string, integrationType: string): ClientCredentials | null {
Padr√£o 3: Map/forEach

// ERRADO:
const pagesData = pages.map((page: any) => {
// CORRETO:
interface Page { id: string; title: string; /* ... */ }
const pagesData = pages.map((page: Page) => {
üü¢ SE√á√ÉO 4: SEGURAN√áA - ITENS J√Å CORRIGIDOS
4.1 Credenciais Hardcoded
‚úÖ STATUS: OK - Nenhuma chave sk_live_ ou sk_test_ encontrada no c√≥digo.

4.2 Prote√ß√£o de Rotas
‚úÖ STATUS: OK - Middleware 
requireTenant
 implementado corretamente.

4.3 Valida√ß√£o Zod
‚úÖ STATUS: PARCIAL - Implementado em 
auth.ts
, mas falta em outras rotas.

Rotas que PRECISAM de valida√ß√£o Zod:

server/routes/credentials.ts
server/routes/clients.ts
server/routes/workspace.ts
server/routes/pagarmePublic.ts
 (j√° parcialmente implementado)
üèóÔ∏è SE√á√ÉO 5: ARQUITETURA E PERFORMANCE
5.1 Lazy Loading
‚úÖ STATUS: IMPLEMENTADO em 
PlatformRouter.tsx

5.2 N+1 Queries
‚úÖ STATUS: OK - Rotas de dashboard usam batch fetching.

5.3 Session Secret Fallback (CORRIGIR)
Arquivo: 
server/index.ts
 Linha 61:

// PROBLEMA: Fallback de segredo de sess√£o
secret: process.env.SESSION_SECRET || 'default-dev-secret-change-in-production',
// SOLU√á√ÉO: For√ßar uso de vari√°vel de ambiente
secret: process.env.SESSION_SECRET || (() => { 
  if (process.env.NODE_ENV === 'production') {
    throw new Error('SESSION_SECRET is required in production');
  }
  return 'dev-secret-only';
})(),
üìù SE√á√ÉO 6: PLANO DE A√á√ÉO PARA CLAUDE OPUS 4.5
Fase 1: Remo√ß√£o do Stripe (CR√çTICA)
 Deletar 
src/features/revendedora/services/StripeService.ts
 Remover export do Stripe de src/features/revendedora/index.ts
 Refatorar 
PaymentCard.tsx
 para usar Pagar.me
 Atualizar 
PaymentService.ts
 para usar rotas Pagar.me
 Remover depend√™ncias Stripe do 
package.json
 Atualizar refer√™ncia em 
database.ts
 (stripe_account_id ‚Üí pagarme_recipient_id)
 Corrigir coment√°rio em 
CommissionConfiguration.tsx
Fase 2: Qualidade de C√≥digo
 Criar server/lib/logger.ts com Pino
 Substituir console.log por logger estruturado (priorizar server/services/)
 Corrigir tipagem 
any
 nos arquivos principais
Fase 3: Seguran√ßa
 Implementar valida√ß√£o Zod em 
credentials.ts
 Implementar valida√ß√£o Zod em 
clients.ts
 Corrigir fallback de SESSION_SECRET
üìÅ ARQUIVOS PARA ENVIAR AO CLAUDE OPUS 4.5
Para a gera√ß√£o de c√≥digo, envie os seguintes arquivos:

Prioridade 1 (Stripe Removal):
src/features/revendedora/services/StripeService.ts
src/features/revendedora/services/PaymentService.ts
src/features/revendedora/pages/reseller/PaymentCard.tsx
src/features/revendedora/index.ts
package.json
Prioridade 2 (Types):
server/routes/workspace.ts
server/routes/dashboard.ts
server/lib/credentialsManager.ts
Prioridade 3 (Logger):
server/vite.ts (refer√™ncia de log existente)
server/services/pagarme.ts
‚ö†Ô∏è VARI√ÅVEIS DE AMBIENTE OBRIGAT√ìRIAS
Certifique-se de que as seguintes vari√°veis estejam configuradas no Replit:

# Pagar.me V5
CHAVE_SECRETA=sk_xxxxxxxxxxxx
CHAVE_PUBLICA=pk_xxxxxxxxxxxx
PAGARME_PLATFORM_RECIPIENT_ID=rp_xxxxxxx  # Opcional
PAGARME_PLATFORM_FEE_PERCENT=2            # Opcional
# Supabase Owner
SUPABASE_OWNER_URL=https://xxx.supabase.co
SUPABASE_OWNER_SERVICE_KEY=eyJxxxx
# Seguran√ßa
SESSION_SECRET=gerar-com-openssl-rand-base64-32
CREDENTIALS_ENCRYPTION_KEY_BASE64=gerar-com-openssl-rand-base64-32
# 100ms Meetings
HMS_ACCESS_KEY=xxx
HMS_SECRET=xxx
HMS_TEMPLATE_ID=xxx
üìä M√âTRICAS FINAIS
M√©trica	Valor
Total de arquivos analisados	150+
Arquivos para deletar	1
Arquivos para refatorar	6
Linhas de c√≥digo a remover	~500
Linhas de c√≥digo a corrigir	~2000
Depend√™ncias a remover	3
FIM DO RELAT√ìRIO DE AUDITORIA

Este documento foi gerado automaticamente pelo Gemini 3 Pro e deve ser usado como input para o Claude Opus 4.5 na fase de gera√ß√£o de c√≥digo.