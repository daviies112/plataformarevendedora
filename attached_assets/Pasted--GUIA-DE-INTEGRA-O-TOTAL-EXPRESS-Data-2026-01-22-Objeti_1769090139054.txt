üì¶ GUIA DE INTEGRA√á√ÉO TOTAL EXPRESS
Data: 2026-01-22
Objetivo: Integrar API da Total Express na p√°gina de Envio ("Enviar") para cota√ß√£o e registro de coletas.

üèóÔ∏è ARQUITETURA PROPOSTA
A integra√ß√£o ser√° feita atrav√©s de um novo servi√ßo dedicado (TotalExpressService) que ser√° consumido pelo j√° existente 
EnvioService
.

1. Vari√°veis de Ambiente Necess√°rias (.env)
TOTAL_EXPRESS_LOGIN=seu_login
TOTAL_EXPRESS_PASSWORD=sua_senha
TOTAL_EXPRESS_CNPJ=seu_cnpj (sem pontua√ß√£o)
TOTAL_EXPRESS_API_URL=https://edi.totalexpress.com.br/webservice_calculo_frete.php (Cota√ß√£o)
TOTAL_EXPRESS_API_REGISTRO_URL=https://edi.totalexpress.com.br/webservice_e_total.php (Registro)
üõ†Ô∏è IMPLEMENTA√á√ÉO BACKEND
1. Novo Servi√ßo: server/services/totalExpressService.ts
Este servi√ßo encapsular√° toda a comunica√ß√£o com a API da Total Express (que geralmente √© SOAP ou REST/XML). Recomendamos usar axios e um parser XML se a resposta for XML.

import axios from 'axios';
// Instalar xml2js: npm install xml2js
// npm install @types/xml2js
import { parseStringPromise } from 'xml2js';
export class TotalExpressService {
  private login = process.env.TOTAL_EXPRESS_LOGIN;
  private password = process.env.TOTAL_EXPRESS_PASSWORD;
  private cnpj = process.env.TOTAL_EXPRESS_CNPJ;
  // Cota√ß√£o de Frete
  async cotarFrete(dados: {
    cepOrigem: string;
    cepDestino: string;
    peso: number; // kg
    valorDeclarado: number;
    tipoServico?: string; // Ex: 'EXP', 'STD'
  }) {
    // A API de cota√ß√£o geralmente √© GET com params
    const url = process.env.TOTAL_EXPRESS_API_URL;
    
    try {
      const response = await axios.get(url!, {
        params: {
          Usuario: this.login,
          Senha: this.password,
          Cnpj: this.cnpj,
          TipoServico: dados.tipoServico || 'EXP', // Expresso como default
          CepOrigem: dados.cepOrigem.replace(/\D/g, ''),
          CepDestino: dados.cepDestino.replace(/\D/g, ''),
          Peso: dados.peso,
          ValorDeclarado: dados.valorDeclarado
        }
      });
      // Se resposta for XML, fazer parse
      // Exemplo simplificado (verificar documenta√ß√£o oficial para estrutura exata)
      /* 
      Respostas t√≠picas TotalExpress:
      <DadosFrete>
        <Prazo>5</Prazo>
        <Valor>25.50</Valor>
        <Erro>0</Erro>
      </DadosFrete>
      */
      
      // Parse XML response here using xml2js
      return response.data; // Adapte para retornar { valor: number, prazo: number }
    } catch (error) {
      console.error('[TotalExpress] Erro na cota√ß√£o:', error);
      throw error;
    }
  }
  // Registro de Encomenda (Gerar Etiqueta/Coleta)
  async registrarColeta(dadosEnvio: any) {
    const url = process.env.TOTAL_EXPRESS_API_REGISTRO_URL;
    
    // Montar XML de solicita√ß√£o conforme manual TotalExpress
    const xmlBody = `
      <hml>
        <CnpjRemetente>${this.cnpj}</CnpjRemetente>
        <Login>${this.login}</Login>
        <Senha>${this.password}</Senha>
        <Encomendas>
           <Encomenda>
             <Pedido>${dadosEnvio.contract_id}</Pedido>
             <NomeDestinatario>${dadosEnvio.destinatario_nome}</NomeDestinatario>
             ...
           </Encomenda>
        </Encomendas>
      </hml>
    `;
    // POST request
    // Lidar com resposta, salvar c√≥digo de rastreio (Etiqueta/Awb)
  }
  
  // Rastreamento (Webhook ou Polling)
  // Recomenda-se configurar Webhook no painel da TotalExpress para receber POSTs em:
  // https://sua-plataforma.com/api/webhooks/total-express
}
export const totalExpressService = new TotalExpressService();
2. Atualizar 
envioService.ts
Modificar o m√©todo 
calcularFrete
 para incluir a Total Express:

import { totalExpressService } from './totalExpressService';
// Dentro de EnvioService.calcularFrete...
async calcularFrete(...) {
  // ... (c√≥digo existente para outras transportadoras)
  // Adicionar cota√ß√£o Total Express
  try {
    const cotacaoTotal = await totalExpressService.cotarFrete({
      cepOrigem: dados.cepOrigem,
      cepDestino: dados.cepDestino,
      peso: dados.peso,
      valorDeclarado: dados.valorDeclarado
    });
    if (cotacaoTotal) {
      // Adicionar ao array de cota√ß√µes retornadas
      cotacoes.push({
        transportadora_nome: 'Total Express',
        servico: 'Expresso',
        valor_frete: cotacaoTotal.valor,
        prazo_dias: cotacaoTotal.prazo,
        // ...
      });
    }
  } catch (e) {
    console.error('Falha ao cotar Total Express', e);
  }
  return cotacoes.sort(...);
}
üíª IMPLEMENTA√á√ÉO FRONTEND
EnvioEnviar.tsx
A p√°gina j√° chama createEnvioMutation que usa /api/envio/envios. Para suportar m√∫ltiplas op√ß√µes de frete (agora com TotalExpress), o fluxo ideal seria:

Step 1: Preencher dados + Clicar em "Cotar Frete"

Chama /api/envio/cotacoes/calcular
Exibe lista de cota√ß√µes (Correios, TotalExpress, JadLog...)
Step 2: Selecionar a cota√ß√£o desejada

Step 3: Criar Envio Final

Enviar cotacao_id selecionada
Backend usa a transportadora correta para registrar o envio.
Mudan√ßa necess√°ria no UI:

Adicionar bot√£o "Calcular Frete" antes de "Criar Envio".
Mostrar tabela de op√ß√µes de frete retornadas.
Usu√°rio seleciona uma op√ß√£o ‚Üí Bot√£o "Gerar Etiqueta" fica habilitado.
üîÑ RASTREAMENTO (TRACKING)
Cria√ß√£o de Webhook Endpoint
Para receber atualiza√ß√µes de status autom√°ticas da Total Express:

Novo arquivo: server/routes/webhooks/totalExpress.ts

router.post('/total-express', async (req, res) => {
  const { awb, status, dataEvento } = req.body; // Adaptar conforme payload real
  
  try {
    // Buscar envio pelo c√≥digo de rastreio (AWB)
    const envio = await envioService.getEnvioByRastreio(awb);
    
    if (envio) {
      await envioService.addRastreamentoEvento({
        envio_id: envio.id,
        status: status,
        data_hora: dataEvento,
        origem_api: true
      });
      
      // Atualizar status principal do envio se necess√°rio
    }
    
    res.send('OK');
  } catch (error) {
    res.status(500).send('Erro');
  }
});
üìù PASSO A PASSO PARA EXECU√á√ÉO
Obter Credenciais: Solicitar acesso API Webservice ao gerente de contas TotalExpress.
Backend:
Criar server/services/totalExpressService.ts.
Modificar 
EnvioService
 para chamar esse novo servi√ßo.
Criar rota de webhook.
Frontend:
Atualizar 
EnvioEnviar.tsx
 para permitir simula√ß√£o de frete antes da cria√ß√£o.
Testes:
Testar cota√ß√£o com CEPs reais.
Gerar etiqueta em ambiente de homologa√ß√£o (HML).
Observa√ß√£o: A documenta√ß√£o oficial da Total Express (Manual de Integra√ß√£o Webservice) deve ser consultada para os nomes exatos dos par√¢metros XML, que podem variar conforme a vers√£o da API contratada.