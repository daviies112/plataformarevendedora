üõ°Ô∏è SISTEMA DE CR√âDITOS & WALLET (ANTI-CALOTE)
Objetivo: Eliminar a inadimpl√™ncia transformando a plataforma em um modelo PR√â-PAGO. NENHUM servi√ßo oneroso (consulta CPF, envio SMS, cria√ß√£o de contrato) √© executado sem saldo pr√©vio.

1. üèóÔ∏è ARQUITETURA DO BANCO DE DADOS
Precisamos de duas novas tabelas essenciais no Supabase para gerenciar o dinheiro dos clientes.

Tabela: wallets
Armazena o saldo atual de cada cliente/tenant.

CREATE TABLE wallets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id UUID NOT NULL REFERENCES tenants(id),
  balance DECIMAL(10, 2) NOT NULL DEFAULT 0.00,
  currency VARCHAR(3) DEFAULT 'BRL',
  is_frozen BOOLEAN DEFAULT FALSE, -- Para bloqueios administrativos
  auto_recharge BOOLEAN DEFAULT FALSE,
  auto_recharge_trigger DECIMAL(10, 2), -- Quando saldo < X
  auto_recharge_amount DECIMAL(10, 2), -- Recarregar Y
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
-- Index para busca r√°pida por tenant
CREATE UNIQUE INDEX idx_wallets_tenant ON wallets(tenant_id);
Tabela: transactions
Hist√≥rico imut√°vel de todas as movimenta√ß√µes (Auditoria Financeira).

CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  wallet_id UUID NOT NULL REFERENCES wallets(id),
  type VARCHAR(20) NOT NULL CHECK (type IN ('CREDIT', 'DEBIT', 'REFUND', 'BONUS')),
  amount DECIMAL(10, 2) NOT NULL, -- Valores positivos. O tipo define se soma ou subtrai.
  description TEXT NOT NULL, -- Ex: "Consulta CPF 123...", "Recarga PIX"
  reference_id VARCHAR(100), -- ID externo (Order ID Pagarme, ID da Consulta)
  reference_type VARCHAR(50), -- 'PAGARME_ORDER', 'CONSULTA_CPF', 'ENVIO_SMS'
  status VARCHAR(20) DEFAULT 'COMPLETED', -- 'PENDING' (para boletos), 'COMPLETED', 'FAILED'
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  metadata JSONB -- Dados extras
);
2. üö¶ MIDDLEWARE DE PROTE√á√ÉO (O GUARDI√ÉO)
Antes de executar qualquer a√ß√£o custosa, o backend deve verificar o saldo. N√ÉO confie no frontend.

Arquivo: server/middleware/checkBalance.ts

export const checkBalance = (cost: number) => {
  return async (req, res, next) => {
    const tenantId = req.user.tenantId;
    
    // 1. Buscar Carteira
    const wallet = await db.wallets.findOne({ tenant_id: tenantId });
    
    // 2. Validar Saldo
    if (!wallet || wallet.balance < cost) {
      return res.status(402).json({
        error: "INSUFFICIENT_FUNDS",
        message: "Saldo insuficiente para realizar esta opera√ß√£o.",
        required: cost,
        current: wallet?.balance || 0
      });
    }
    // 3. Adicionar wallet ao request para uso posterior
    req.wallet = wallet;
    next();
  };
};
// USO NAS ROTAS:
router.post('/consultas/cpf', checkBalance(5.00), async (req, res) => {
    // Se chegou aqui, tem saldo (mas ainda n√£o debitou!)
    
    // 1. Tenta executar o servi√ßo externo
    const resultado = await apiExterna.consultar(req.body.cpf);
    
    // 2. SE SUCESSO: Debita
    await walletService.debit(req.wallet.id, 5.00, 'Consulta CPF ABC');
    
    res.json(resultado);
});
3. üí≥ FLUXO DE RECARGA (PAGAR.ME V5)
O cliente precisa colocar dinheiro para usar.

Interface de Recarga:

Modal "Adicionar Cr√©ditos".
Op√ß√µes: R$ 50, R$ 100, R$ 500, Outro.
M√©todo: PIX (Instant√¢neo) ou Cart√£o.
Processamento (Backend):

Cria Order na Pagar.me.
Retorna QR Code Pix ou Status Cart√£o.
Webhook (Cr√≠tico):

O Backend recebe order.paid da Pagar.me.
AUTOMATICAMENTE adiciona cr√©dito na wallets.
Cria registro em transactions (Type: CREDIT).
4. üîÑ AUTO-RECARGA (O SEGREDO DA RECEITA RECORRENTE)
Para evitar que o servi√ßo pare no meio do dia:

Cliente salva cart√£o (Tokeniza√ß√£o Pagar.me).
Configura: "Se saldo < R$ 20,00, recarregar R$ 100,00 automaticamente".
Cronjob/Trigger:
A cada d√©bito, verificar if (novoSaldo < trigger && autoRecharge).
Se sim, disparar cobran√ßa no cart√£o salvo.
Se aprovado, creditar na hora.
5. üñ•Ô∏è IMPLEMENTA√á√ÉO NA PLATAFORMA (Checklist)
Fase 1: Funda√ß√£o (Backend)
 Criar Migrations SQL (wallets, transactions).
 Criar WalletService (addFunds, debitFunds, getBalance).
 Criar Middleware checkBalance.
Fase 2: Integra√ß√£o Financeira
 Rota /api/wallet/recharge (Integra√ß√£o Pagar.me V5).
 Webhook Handler para processar order.paid e creditar saldo.
Fase 3: Frontend (UX)
 Header: Mostrar saldo atual (ex: R$ 150,00). Mudar cor se baixo.
 P√°gina Financeiro: Extrato detalhado (Entradas/Sa√≠das).
 Bot√£o Recarregar: Modal com QR Code Pix instant√¢neo.
 Bloqueio de UI: Desabilitar bot√µes "Consultar" se saldo for zero.
üí° POR QUE ISSO ELIMINA O CALOTE?
Risco Zero: Voc√™ recebe ANTES de gastar com o fornecedor (API de consulta, SMS, etc).
Fluxo de Caixa Positivo: O dinheiro entra na sua conta antes de sair.
Sem Cobran√ßa: N√£o precisa ligar cobrando fatura atrasada. Se n√£o pagar, o servi√ßo simplesmente para de funcionar (soft block).